<!DOCTYPE html><html><head><meta charset="utf-8"><title>Source: Context.js</title><meta name="viewport" content="width=device-width,initial-scale=1"><script src="scripts/prettify/prettify.js"></script><script src="scripts/prettify/lang-css.js"></script><script src="scripts/jquery.min.js"></script><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><link href="https://fonts.googleapis.com/css?family=Libre+Franklin:400,700" rel="stylesheet"><link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css"><link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css"><link type="text/css" rel="stylesheet" href="styles/main.css"><script>var config = {"monospaceLinks":false,"cleverLinks":false,"default":{"outputSourceFiles":true}};</script></head><body><div id="wrap" class="clearfix"><div class="navigation"><h3 class="applicationName"><a href="index.html"></a></h3><button id="menuToggle" class="btn btn-link btn-lg menu-toggle"><span class="glyphicon glyphicon-menu-hamburger"></span></button><div class="search"><input id="search" type="text" class="form-control input-md" placeholder="Search..."></div><ul class="list"><li class="item" data-name="global"><span class="title namespace"><span class="namespaceTag"><span class="glyphicon glyphicon-globe"></span> </span><a href="global.html">Global</a></span><ul class="members itemMembers"><span class="subtitle">Members</span><li class="parent" data-name="Config"><a href="global.html#Config">Config</a></li><li class="parent" data-name="Util"><a href="global.html#Util">Util</a></li></ul><ul class="typedefs itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="methods itemMembers"></ul><ul class="events itemMembers"></ul></li><li class="item" data-name="Application"><span class="title"><a href="Application.html">Application</a></span><ul class="members itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="methods itemMembers"><span class="subtitle">Methods</span><li class="parent" data-name="Application#gotoView"><a href="Application.html#gotoView">gotoView</a></li><li class="parent" data-name="Application#initialize"><a href="Application.html#initialize">initialize</a></li></ul><ul class="events itemMembers"></ul></li><li class="item" data-name="Cache"><span class="title"><a href="Cache.html">Cache</a></span><ul class="members itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="methods itemMembers"><span class="subtitle">Methods</span><li class="parent" data-name="Cache#clear"><a href="Cache.html#clear">clear</a></li><li class="parent" data-name="Cache#delete"><a href="Cache.html#delete">delete</a></li><li class="parent" data-name="Cache#get"><a href="Cache.html#get">get</a></li><li class="parent" data-name="Cache#has"><a href="Cache.html#has">has</a></li><li class="parent" data-name="Cache#length"><a href="Cache.html#length">length</a></li><li class="parent" data-name="Cache#set"><a href="Cache.html#set">set</a></li></ul><ul class="events itemMembers"></ul></li><li class="item" data-name="Content"><span class="title"><a href="Content.html">Content</a></span><ul class="members itemMembers"><span class="subtitle">Members</span><li class="parent" data-name="Content#namespace"><a href="Content.html#namespace">namespace</a></li></ul><ul class="typedefs itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="methods itemMembers"><span class="subtitle">Methods</span><li class="parent" data-name="Content#initialize"><a href="Content.html#initialize">initialize</a></li></ul><ul class="events itemMembers"></ul></li><li class="item" data-name="Context"><span class="title"><a href="Context.html">Context</a></span><ul class="members itemMembers"><span class="subtitle">Members</span><li class="parent" data-name="Context#root"><a href="Context.html#root">root</a></li><li class="parent" data-name="Context#view"><a href="Context.html#view">view</a></li><li class="parent" data-name="Context#viewModel"><a href="Context.html#viewModel">viewModel</a></li><li class="parent" data-name="Context#viewName"><a href="Context.html#viewName">viewName</a></li></ul><ul class="typedefs itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="methods itemMembers"><span class="subtitle">Methods</span><li class="parent" data-name="Context#addChild"><a href="Context.html#addChild">addChild</a></li></ul><ul class="events itemMembers"></ul></li><li class="item" data-name="View"><span class="title"><a href="View.html">View</a></span><ul class="members itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="methods itemMembers"><span class="subtitle">Methods</span><li class="parent" data-name="View#initialize"><a href="View.html#initialize">initialize</a></li></ul><ul class="events itemMembers"></ul></li><li class="item" data-name="ViewModel"><span class="title"><a href="ViewModel.html">ViewModel</a></span><ul class="members itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="typedefs itemMembers"></ul><ul class="methods itemMembers"><span class="subtitle">Methods</span><li class="parent" data-name="ViewModel#bind"><a href="ViewModel.html#bind">bind</a></li><li class="parent" data-name="ViewModel#unbind"><a href="ViewModel.html#unbind">unbind</a></li></ul><ul class="events itemMembers"></ul></li></ul></div><div class="main"><h1 class="page-title" data-filename="Context.js.html">Source: Context.js</h1><section><header><div class="header content-size"><h2>Context.js</h2></div></header><article><pre id="source-code" class="prettyprint source"><code>/**
 * @class
 */
export class Context
{
    /**
     * @param {number} [width=240]
     * @param {number} [height=240]
     * @param {number} [fps=30]
     * @param {object} [options=null]
     *
     * @constructor
     * @public
     */
    constructor (width = 240, height = 240, fps = 30, options = null)
    {
        /**
         * @type {next2d.fw.View}
         * @default null
         * @private
         */
        this._$view = null;

        /**
         * @type {next2d.fw.ViewModel}
         * @default null
         * @private
         */
        this._$viewModel = null;

        /**
         * @type {string}
         * @default "top"
         * @private
         */
        this._$viewName = "Top";

        /**
         * @type {next2d.display.Sprite}
         * @private
         */
        this._$root = next2d.createRootMovieClip(
            width, height, fps, options
        );

        const { Event } = next2d.events;

        const stage = this._$root.stage;
        stage.addEventListener(Event.REMOVED, (event) =>
        {
            const view = event.target;

            if (view instanceof next2d.fw.View) {

                if (this._$viewModel) {
                    this._$viewModel.unbind(view);
                    this._$viewModel = null;
                }

                const name = this.viewName;

                const contentName = `${name}Content`;
                if (!next2d.fw.packages.has(contentName)) {
                    return ;
                }

                const routing = next2d.fw.config.routing[
                    name
                        .replace(/[A-Z]/g, (s) =>
                        {
                            return `/${s.charAt(0).toLowerCase()}`;
                        })
                        .slice(1)
                ];
                if (!routing || !routing.requests) {
                    return ;
                }

                const loaderInfoMap = next2d.fw.loaderInfo;

                const requests = routing.requests;
                for (let idx = 0; idx &lt; requests.length; ++idx) {

                    const object = requests[idx];
                    if (object.name === contentName) {

                        if (!object.cache &amp;&amp; loaderInfoMap.has(contentName)) {

                            const loaderInfo = loaderInfoMap.get(contentName);
                            const symbols    = loaderInfo._$data.symbols;
                            if (symbols.size) {
                                for (const name of symbols.keys()) {
                                    loaderInfoMap.delete(
                                        name.split(".").pop()
                                    );
                                }
                            }

                        }

                        break;
                    }
                }
            }
        }, true);
    }

    /**
     * @return {next2d.display.Sprite}
     * @readonly
     * @public
     */
    get root ()
    {
        return this._$root;
    }

    /**
     * @return {next2d.fw.View}
     * @readonly
     * @public
     */
    get view ()
    {
        return this._$view;
    }

    /**
     * @return {next2d.fw.ViewModel}
     * @readonly
     * @public
     */
    get viewModel ()
    {
        return this._$viewModel;
    }

    /**
     * @return {string}
     * @default "top"
     * @readonly
     * @public
     */
    get viewName ()
    {
        return this._$viewName;
    }

    /**
     * ViewクラスをrootのSpriteにアタッチします。
     * Attach the View class to the root Sprite.
     * @param  {string} name
     * @param  {array}  responses
     * @return {ViewModel|null}
     * @public
     */
    addChild (name, responses)
    {
        const names = name.split(/[-_/]/);

        let viewName = "";
        for (let idx = 0; names.length > idx; ++idx) {
            name = names[idx];
            viewName += name
                .charAt(0)
                .toUpperCase() + name.slice(1);
        }
        this._$viewName = viewName;
        viewName += "View";

        const viewModelName = `${viewName}Model`;

        if (!next2d.fw.packages.has(viewName)
            || !next2d.fw.packages.has(viewModelName)
        ) {
            return null;
        }

        if (next2d.fw.response.size) {
            next2d.fw.response.clear();
        }

        if (responses.length) {
            for (let idx = 0; idx &lt; responses.length; ++idx) {

                const object = responses[idx];
                if (!object || !object.name) {
                    continue;
                }

                next2d.fw.response.set(object.name, object.response);
            }
        }

        const ViewClass = next2d.fw.packages.get(viewName);
        this._$view = new ViewClass();

        const ViewModelClass = next2d.fw.packages.get(viewModelName);
        this._$viewModel = new ViewModelClass();

        return Promise
            .resolve(this._$viewModel.bind(this._$view))
            .then(() =>
            {
                if (next2d.fw.config.loading) {
                    this._$endLoading();
                }

                while (this._$root.numChildren) {
                    this._$root.removeChild(this._$root.getChildAt(0));
                }

                return this._$root.addChild(this._$view);
            })
            .catch((error) =>
            {
                console.error(error);
            });
    }

    /**
     * @return {void}
     * @private
     */
    _$endLoading ()
    {
        const config = next2d.fw.config;
        if (!config.loading) {
            return ;
        }

        const callback = config.loading.callback;
        if (!callback) {
            return ;
        }

        const packages = next2d.fw.packages;

        const CallbackClass = packages.has(callback)
            ? packages.get(callback)
            : next2d.fw.Loading;
        new CallbackClass().end();
    }
}</code></pre></article></section><footer class="content-size"><div class="footer">Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Dec 31 2021 03:12:17 GMT+0900 (日本標準時)</div></footer></div></div><script>prettyPrint();</script><script src="scripts/main.js"></script></body></html>